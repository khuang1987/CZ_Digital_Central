# MES批次报工记录算法说明

## 概述
本文档说明MES批次报工记录数据处理中的关键计算字段及其算法规则。

## 核心计算字段

### 1. LT(d) - 工序周期时间
**计算公式**: 工序报工时间 - 进入工序时间（天）
**特殊规则**: 
- 如果ERP工序号为0010：使用 `TrackOutTime - CheckinSFC`
- 其他工序：使用 `TrackOutTime - EnterStepTime`
**单位**: 天，保留2位小数

### 2. PT(d) - 加工周期时间  
**计算公式**: 工序报工时间 - 开始时间（天）
**优先级**: 优先使用CheckinSFC，否则使用StartTime
**单位**: 天，保留2位小数

### 3. ST(d) - 标准时间
**计算公式**: `(数量 × EffectiveTime / OEE + SetupTime) / 24`
**参数说明**:
- EffectiveTime: 优先使用Machine时间，否则使用Labor时间
- OEE: 默认值77%（当值为空或0时）
- SetupTime: 仅当Setup="Yes"时计入
**单位**: 天，保留2位小数

### 4. DueTime - 应完工时间
**计算步骤**:
1. 基础时间 = TrackInTime + 总工时 + 0.5小时换批时间
2. 自动顺延周末：统计[start+1d, due]间的完整周末天数，累加到截止时间
3. 递归检查：确保顺延后不再跨周末

### 5. Weekend(d) - 周末扣除天数
**计算逻辑**: 统计从开始时间到应完工时间之间的完整周末天数
**周末定义**: 周日(0)和周六(6)

### 6. CompletionStatus - 完工状态
**判断规则**:
- OnTime: 实际完工时间 ≤ 应完工时间
- Overdue: 实际完工时间 > 应完工时间

### 7. Machine(#) - 设备编号
**提取规则**: 从ResourceCode中提取纯数字部分
**示例**: "M001" → 1, "CNC002" → 2

## 数据标准化规则

### 工序名称标准化
- 数控铣、数控车、线切割等保持原名
- 锯/下料 → 锯
- 热处理/非真空热处理 → 热处理
- 深孔 → 深孔钻

### 类型转换
- 时间字段统一为datetime类型
- 日期字段统一为date类型  
- OEE转换为百分比类型
- 数量字段转换为整数类型
- 工时字段保留2位小数

## 关键业务逻辑

### Setup判断
基于CFN连续性：如果当前CFN与上一个CFN相同，则Setup="No"，否则Setup="Yes"

### 换批时间
标准计算中加入30分钟换批时间，确保生产计划合理性

### 周末处理
自动识别并顺延周末，确保生产计划只考虑工作日


