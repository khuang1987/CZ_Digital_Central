# 增量刷新方案说明

## 问题分析

当前情况：
- 每次全量刷新所有SharePoint Excel文件
- 每天刷新多次，数据量大，刷新时间长
- 包含复杂的计算逻辑（分组、合并、时间计算等）

## 方案对比

### 方案1：保存已计算数据（本地缓存）
**实现方式：**
- 将处理后的数据保存为本地文件（CSV/Parquet）
- 每次刷新时只加载新数据
- 合并历史缓存数据和新数据

**优点：**
- ✅ 性能最好，刷新速度快
- ✅ 稳定可靠，不受网络影响
- ✅ 支持复杂计算，历史数据完整

**缺点：**
- ❌ 需要本地存储空间（通常几百MB到几GB）
- ❌ 需要文件读写权限
- ❌ 需要处理数据合并和去重逻辑
- ❌ 如果源数据更新（不是新增），需要重新计算

**适用场景：**
- 数据量大（>10万行）
- 刷新频率高（每天多次）
- 有本地存储条件
- **推荐指数：⭐⭐⭐⭐⭐（最稳定）**

---

### 方案2：Power Query日期筛选（纯增量）
**实现方式：**
- 使用参数记录最后刷新时间
- 只加载该时间之后创建的文件
- 在Power Query中完成所有计算

**优点：**
- ✅ 不需要本地存储
- ✅ 实时性好
- ✅ 实现简单

**缺点：**
- ❌ **关键问题**：TrackInTime计算依赖历史数据（需要同一ResourceCode的上一条记录）
- ❌ 如果只加载新数据，无法正确计算TrackInTime
- ❌ 需要保留一定历史窗口（建议保留2-4周）
- ❌ 文件删除或修改需要手动处理

**适用场景：**
- 数据新增为主，很少修改
- 可以接受保留历史窗口
- 计算逻辑不依赖完整历史数据
- **推荐指数：⭐⭐⭐（有局限性）**

---

## 推荐方案：混合方案（方案1 + 方案2结合）

### 实现思路

#### 步骤1：创建增量筛选查询
- 添加日期参数筛选
- 只加载新文件

#### 步骤2：创建历史数据缓存
- 保存处理后的完整数据到本地CSV/Parquet
- 每次刷新时读取缓存

#### 步骤3：数据合并策略
```
最终数据 = 历史缓存数据（去重） + 新数据（增量计算）
```

#### 步骤4：更新缓存
- 刷新完成后，将合并后的数据写回缓存文件

### 具体实现

#### 1. 日期参数查询（已创建）
`参数_最后刷新时间.pq`

#### 2. 增量数据查询
修改 `e2_批次报工记录_MES_基础前处理.pq`，添加日期筛选

#### 3. 历史数据缓存查询
创建 `e2_批次报工记录_MES_历史缓存.pq`，从本地文件读取

#### 4. 合并查询
创建 `e2_批次报工记录_MES_合并.pq`，合并历史和新数据

---

## 实施建议

### 短期方案（立即可用）：日期筛选增量加载

**优点：** 快速实现，无需额外配置
**缺点：** 需要保留历史窗口（建议2-4周）

**实施步骤：**
1. 使用 `参数_最后刷新时间` 参数（已创建）
2. 修改基础前处理查询，添加日期筛选
3. 设置参数为2-4周前的日期（作为历史窗口）
4. 每次刷新后，手动更新参数为当前时间

**注意：**
- TrackInTime的计算需要历史数据，所以必须保留历史窗口
- 建议保留至少1个月的历史数据

---

### 长期方案（最稳定）：本地缓存机制

**优点：** 性能最好，最稳定，支持完整历史数据
**缺点：** 需要文件读写权限，需要处理合并逻辑

**实施步骤：**
1. 创建缓存文件存储路径（如：`C:\DataCache\MES_历史数据.csv`）
2. 创建历史数据读取查询
3. 创建数据合并查询（去重+合并）
4. 创建缓存更新查询（Power Query可能受限，可能需要Power Automate或Python脚本）

**技术实现：**
- 使用CSV格式（兼容性好）或Parquet格式（性能好）
- 去重逻辑：基于 `BatchNumber + Operation + TrackOutTime` 组合键
- 更新策略：全量覆盖或增量追加

---

## 数据一致性考虑

### 关键计算依赖

1. **TrackInTime计算**
   - 依赖同一ResourceCode的上一条记录的TrackOutTime
   - **必须保留历史数据**，否则计算不准确

2. **Setup判断**
   - 依赖同一ResourceCode的上一条记录的CFN
   - 也需要历史数据

3. **周末天数计算**
   - 依赖TrackInTime（已计算）
   - 不直接依赖历史数据

### 建议的历史窗口
- **最少：** 1个月历史数据
- **推荐：** 2-3个月历史数据
- **原因：** 确保ResourceCode的历史记录完整

---

## 实施优先级

### 阶段1：快速改进（本周可完成）
1. ✅ 创建日期参数查询
2. ⬜ 修改基础前处理查询，添加日期筛选
3. ⬜ 设置历史窗口（2-4周）
4. ⬜ 测试增量刷新性能

### 阶段2：优化改进（1-2周）
1. ⬜ 实现本地缓存机制
2. ⬜ 创建数据合并查询
3. ⬜ 实现自动更新缓存
4. ⬜ 性能测试和优化

---

## 注意事项

1. **首次使用：** 需要全量刷新一次，建立基准数据
2. **数据修改：** 如果源数据被修改（不是新增），需要重新计算
3. **文件删除：** SharePoint文件删除需要在缓存中也删除
4. **参数更新：** Power Query参数无法自动更新，需要手动维护或使用外部脚本
5. **权限要求：** 本地缓存方案需要文件读写权限

---

## 推荐实施路径

1. **立即采用：** 日期筛选增量加载（方案2），设置3个月历史窗口
2. **评估效果：** 使用1-2周，评估性能和稳定性
3. **升级方案：** 如果性能仍不满足，实施本地缓存机制（方案1）
