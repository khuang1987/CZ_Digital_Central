# 工时数据查询优化说明

## 优化目标
融合B1, B2, B3三个数据源,确保数据类型一致和融合数据可靠

## 已优化的文件

### 1. C1-整合的工时数据.pq (主查询)
**优化点:**
- 直接合并B1、B2、B3三个数据源
- 统一的工时单位转换(秒→小时,保留2位小数)
- 优化的数据处理流程
- 增强错误处理

**使用方式:**
确保Power Query中有以下依赖查询:
- `#"b2-存档的工时数据"`
- `#"b3-每日更新的工时数据"`  
- `#"b1-KH存档的工时数据"`

所有3个数据源都会被直接合并

### 2. B2-存档的工时数据.pq (优化版)
**优化点:**
- 统一数据类型转换: `type number` 替代 `Int64.Type` (提高兼容性)
- 增强错误处理: 使用 `try ... otherwise` 处理数值转换
- 优化代码注释
- 统一列顺序

### 3. B3-每日更新的工时数据.pq (优化版)  
**优化点:**
- 与B2保持完全一致的数据类型转换
- 增强错误处理
- 统一的列顺序和结构

### 4. B1-KH存档的工时数据.pq (已优化)
**优化点:**
- 自动转换中文字段名为英文字段名
- 补充缺失字段,使其结构与B2/B3完全一致
- 输出标准格式的23个字段
- 可直接与B2/B3合并

## 数据类型统一标准

### 标准字段类型
```M
{
    "Posting date": type date,
    "Earned Labor Time": type number, 
    "Actual Quantity": type number,
    "Actual Scrap Qty": type number,
    "Target Quantity": type number,
    "Machine Time": type nullable number
}
```

### 关键优化
1. **数值类型**: 从 `Int64.Type` 改为 `type number` - 提高兼容性,支持小数
2. **错误处理**: 所有转换都使用 `try ... otherwise` 语法
3. **工时单位**: 统一转换为小时(H),保留2位小数

## 数据融合流程

```
B2数据源 (存档) → 标准化
                    ↓
B3数据源 (每日更新) → 标准化 → 合并 → 去重 → 过滤 → 转换 → 输出
                    ↑
B1数据源 (KH存档,可选) → 标准化
```

## 主要优化策略

### 1. 增强错误处理
```M
// 错误安全的数值转换
Table.TransformColumns(原表, {{"字段名", each try Value.ToNumber(_) otherwise 0}})

// 错误安全的过滤
Table.SelectRows(原表, each try (条件) otherwise false)
```

### 2. 统一的数据类型
- 所有数值字段统一为 `type number`
- 可空字段使用 `type nullable number`
- 日期字段使用 `type date`

### 3. 数据验证
- 过滤无效的Posting date
- 过滤OSP工作中心
- 只保留2024年4月27日之后的数据
- 统一Production Scheduler代码

## 使用建议

1. **首次使用**: 先确保B2和B3查询正常工作
2. **B1整合**: 如果需要整合B1数据,建议创建独立的转换查询
3. **性能优化**: 建议在数据源查询中完成所有必要的数据清洗
4. **错误排查**: 如果遇到错误,检查源文件格式是否符合预期

## 注意事项

✅ **完成状态**
- 已更新B1数据源,自动转换为标准格式
- B1、B2、B3三个数据源可直接合并
- 所有数据源使用统一的字段结构(23个字段)

## 使用步骤

1. 确保Power Query中存在3个查询:
   - `b2-存档的工时数据`
   - `b3-每日更新的工时数据`  
   - `b1-KH存档的工时数据`
2. 刷新 `C1-整合的工时数据` 查询
3. 三个数据源将自动合并并输出标准化的工时数据

