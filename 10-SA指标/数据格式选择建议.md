# 处理后数据格式选择建议

## 场景说明

**数据流程：**
1. 本地读取XLSX源数据
2. Power Query本地处理（计算、合并等）
3. 保存处理后的数据到SharePoint
4. Power BI从SharePoint读取并呈现

**关键要求：**
- 读取速度快
- 文件大小适中
- SharePoint支持良好
- Power BI兼容性好

---

## 格式对比

### 1. Parquet格式 ⭐⭐⭐⭐⭐（推荐）

**文件扩展名：** `.parquet`

**优点：**
- ✅ **性能最佳**：列式存储，读取速度快（通常比CSV快10-100倍）
- ✅ **文件小**：压缩率高，通常比CSV小70-90%
- ✅ **类型保留**：自动保留数据类型（日期、数字、文本等）
- ✅ **Power BI原生支持**：Power BI可以直接读取Parquet文件
- ✅ **适合大数据**：处理百万级行数据性能优秀

**缺点：**
- ⚠️ SharePoint上传需要手动或脚本（但Power BI可以直接读取SharePoint中的Parquet）
- ⚠️ 无法用Excel直接打开查看（但Power BI可以）

**示例文件大小：**
- 100万行数据：CSV约500MB → Parquet约50-80MB

**适用场景：**
- 数据量大（>10万行）
- 需要快速刷新
- **强烈推荐用于您的场景**

---

### 2. CSV格式 ⭐⭐⭐（备选）

**文件扩展名：** `.csv`

**优点：**
- ✅ **兼容性最好**：任何工具都能打开
- ✅ **SharePoint支持**：可以直接上传
- ✅ **Excel可查看**：可以直接用Excel打开验证
- ✅ **简单直观**：文本格式，易于调试

**缺点：**
- ❌ **文件大**：无压缩，文件体积大
- ❌ **读取慢**：Power BI读取CSV较慢
- ❌ **类型丢失**：所有数据都是文本，需要重新转换类型
- ❌ **特殊字符问题**：可能遇到编码问题

**示例文件大小：**
- 100万行数据：CSV约500MB

**适用场景：**
- 数据量小（<10万行）
- 需要人工查看验证
- 作为Parquet的备选方案

---

### 3. Excel格式 (XLSX) ⭐⭐（不推荐）

**文件扩展名：** `.xlsx`

**优点：**
- ✅ 可以直接用Excel打开查看

**缺点：**
- ❌ **文件很大**：通常比CSV还大
- ❌ **读取最慢**：Power BI读取Excel很慢
- ❌ **行数限制**：Excel最多1048576行
- ❌ **性能差**：不适合大数据场景

**适用场景：**
- 数据量很小（<10万行）
- 需要人工频繁查看
- **不推荐用于您的场景**

---

### 4. Delta Lake格式 ⭐⭐⭐⭐（高级选项）

**文件扩展名：** `.delta` 或文件夹结构

**优点：**
- ✅ 支持ACID事务
- ✅ 支持更新和删除
- ✅ 性能优秀

**缺点：**
- ❌ 需要额外配置
- ❌ Power BI支持有限
- ❌ 实施复杂

**适用场景：**
- 需要支持数据更新和删除的场景
- 高级数据湖场景
- **当前场景不推荐**

---

## 推荐方案

### 方案1：Parquet格式（首选）⭐⭐⭐⭐⭐

**实施步骤：**

1. **本地处理完成后保存为Parquet**
```powerquery
// 在Power Query中保存为Parquet
Table.ToParquet(处理后的数据, "C:\本地路径\处理后数据.parquet")
```

2. **上传到SharePoint**
   - 方法1：手动上传到SharePoint文档库
   - 方法2：使用Power Automate自动上传
   - 方法3：使用Python/PowerShell脚本上传

3. **Power BI读取**
```powerquery
// Power BI中从SharePoint读取Parquet
Source = SharePoint.Files("https://...sharepoint.com/...", [ApiVersion = 15]),
FilteredFile = Table.SelectRows(Source, each [Name] = "处理后数据.parquet"),
BinaryContent = FilteredFile{0}[Content],
ParquetData = Parquet.Document(BinaryContent)
```

**优点：**
- 性能最好
- 文件最小
- Power BI原生支持

---

### 方案2：CSV格式（备选）⭐⭐⭐

**实施步骤：**

1. **本地处理完成后保存为CSV**
```powerquery
// 在Power Query中保存为CSV
Csv.Document(Table.ToCsv(处理后的数据), [Delimiter=",", Encoding=65001])
```

2. **上传到SharePoint**
   - 直接拖拽上传即可

3. **Power BI读取**
```powerquery
// Power BI中从SharePoint读取CSV
Source = SharePoint.Files("https://...sharepoint.com/...", [ApiVersion = 15]),
FilteredFile = Table.SelectRows(Source, each [Name] = "处理后数据.csv"),
CsvContent = Csv.Document(FilteredFile{0}[Content], [Delimiter=",", Encoding=65001])
```

**优点：**
- 简单直接
- 易于验证

---

## 性能对比（预估）

| 数据量 | CSV读取时间 | Parquet读取时间 | 文件大小对比 |
|--------|------------|----------------|-------------|
| 10万行 | ~30秒 | ~3秒 | CSV: 50MB / Parquet: 5-8MB |
| 50万行 | ~2分钟 | ~8秒 | CSV: 250MB / Parquet: 25-40MB |
| 100万行 | ~5分钟 | ~15秒 | CSV: 500MB / Parquet: 50-80MB |

---

## 最终推荐

### 推荐方案：**Parquet格式**

**理由：**
1. ✅ 您的数据量应该较大（批次报工记录），Parquet性能优势明显
2. ✅ 每天刷新多次，快速读取很重要
3. ✅ Power BI原生支持Parquet
4. ✅ 文件小，上传到SharePoint也更快

**实施建议：**
1. **主方案**：使用Parquet格式
2. **备选方案**：如果遇到兼容性问题，可以同时保存CSV作为备份
3. **文件命名**：建议使用日期版本号，如 `MES_处理后数据_20250115.parquet`

---

## 注意事项

1. **Parquet文件上传到SharePoint：**
   - Power BI可以直接通过SharePoint.Files读取
   - 如果手动上传，需要确保文件完整上传

2. **数据版本管理：**
   - 建议使用日期或时间戳命名文件
   - 或使用版本号：`v1.0`, `v1.1`等

3. **首次实施：**
   - 先用小数据量测试Parquet格式
   - 验证Power BI读取正常
   - 再扩展到完整数据

4. **数据验证：**
   - 保存Parquet的同时，可以保存一份CSV用于人工验证
   - 定期对比Parquet和CSV的数据一致性

---

## 示例代码结构

### 本地处理并保存Parquet

```powerquery
let
    // ... 您的数据处理逻辑 ...
    处理后的数据 = e2_批次报工记录_MES_后处理,
    
    // 保存为Parquet（本地路径）
    ParquetFilePath = "C:\DataCache\MES_处理后数据_" & 
        Text.From(Date.Year(DateTime.LocalNow())) & 
        Text.PadStart(Text.From(Date.Month(DateTime.LocalNow())), 2, "0") &
        Text.PadStart(Text.From(Date.Day(DateTime.LocalNow())), 2, "0") & 
        ".parquet",
    
    // 转换为Parquet
    ParquetContent = Table.ToParquet(处理后的数据),
    
    // 写入文件（需要使用Binary.ToFile，但Power Query可能受限）
    // 注意：Power Query可能无法直接写入文件，需要配合其他工具
    Result = 处理后的数据
in
    Result
```

**注意：** Power Query可能无法直接写入本地文件。建议：
- 方案1：使用Power BI Desktop导出功能
- 方案2：使用Python脚本处理（推荐）
- 方案3：使用Power Automate流程
