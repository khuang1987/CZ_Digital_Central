# SA指标数据清洗配置文件

# 数据源路径配置
# 注意：请填写SharePoint同步到本地的文件路径
source:
  # 多工厂数据源配置
  mes_sources:
    - factory_id: "CZM"
      factory_name: "工厂1-CZM"
      path: "C:\\Users\\huangk14\\OneDrive - Medtronic PLC\\CZ Production - 文档\\General\\POWER BI 数据源 V2\\30-MES导出数据\\Product Output -CZM -FY26.xlsx"
      enabled: true
    
    - factory_id: "CKH"
      factory_name: "工厂2-CKH"
      path: "C:\\Users\\huangk14\\OneDrive - Medtronic PLC\\CZ Production - 文档\\General\\POWER BI 数据源 V2\\30-MES导出数据\\Product Output -CKH -FY26.xlsx"
      enabled: true
  
  # 合并后的标准时间表路径（可选）
  # 使用latest版本，例如：publish/SAP_Routing_latest.parquet
  # 如果为空，自动查找publish目录下的SAP_Routing_latest.parquet文件
  standard_time_path: "C:\\Users\\huangk14\\OneDrive - Medtronic PLC\\CZ Production - 文档\\General\\POWER BI 数据源 V2\\30-MES导出数据\\publish\\SAP_Routing_latest.parquet"
  
  # SFC处理后数据文件路径（用于合并Checkin_SFC字段）
  sfc_latest_file: "C:\\Users\\huangk14\\OneDrive - Medtronic PLC\\CZ Production - 文档\\General\\POWER BI 数据源 V2\\30-MES导出数据\\publish\\SFC_batch_report_latest.parquet"
  
  # 日历工作日表路径（用于判断工作日和节假日）
  calendar_file: "C:\\Users\\huangk14\\OneDrive - Medtronic PLC\\CZ Production - 文档\\General\\POWER BI 数据源 V2\\30-MES导出数据\\publish\\日历工作日表.csv"
  
  # 每日工作时间（小时），用于DueTime计算
  # 设置为24.0表示工作日24小时连续生产，非工作日不生产
  daily_working_hours: 24.0
 
# MES数据字段映射
# 将Excel原始列名映射到标准列名
mes_mapping:
  # 基础标识字段
  "Material_Name": "BatchNumber"
  "Product_Name": "CFN"
  "LogicalFlowPath": "Group"
  "ERPOperation": "Operation"
  "Step_Name": "Operation description"
  "ProductionOrder": "ProductionOrder"
  "Area_Name": "ProductionArea"
  "Resource Description": "ResourceDescription"
  "ERPProdSupervisor": "VSM"
  
  # 时间字段
  "DateEnteredStep": "EnterStepTime"
  "First_TrackIn_Date": "TrackInTime"
  "TrackOutDate": "TrackOutTime"
  
  # 数量字段
  "Step_In_PrimaryQuantity": "StepInQuantity"
  "TrackOut_PrimaryQuantity": "TrackOutQuantity"
  
  # 注意：Resource字段保留原名称，用于提取machine字段

# MES数据类型定义
mes_types:
  # 时间字段
  TrackOutTime: datetime
  EnterStepTime: datetime
  TrackInTime: datetime
  StartTime: datetime
  PreviousBatchEndTime: datetime
  DueTime: datetime
  Checkin_SFC: datetime
  
  # 日期字段
  TrackOutDate: date
  Date created: date
  
  # 数值字段
  StepInQuantity: int
  TrackOutQuantity: int
  Operation: string
  
  # 文本字段
  BatchNumber: string
  CFN: string
  Group: string
  ResourceCode: string
  # 数值字段（整数）
  ProductionOrder: int
  ResourceDescription: string
  ProductionArea: string
  Operation description: string
  VSM: string

# 输出配置
output:
  # 输出目录（保存到SharePoint同步文件夹）
  base_dir: "C:\\Users\\huangk14\\OneDrive - Medtronic PLC\\CZ Production - 文档\\General\\POWER BI 数据源 V2\\30-MES导出数据\\publish"
  
  # 输出格式
  format: "parquet"
  
  # Parquet压缩配置
  parquet:
    compression: "snappy"  # 可选: snappy, gzip, brotli, zstd
  
  # Excel输出配置（用于数据完整性检查）
  excel:
    enabled: true  # 是否启用Excel输出
    max_rows: 2000  # Excel文件最大行数（避免文件过大）
    include_stats: true  # 是否包含统计信息工作表

# 日志配置
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  file: "../06_日志文件/etl_sa.log"

# 去重配置
deduplicate:
  # 是否启用去重
  enabled: true  # 启用跨工厂数据去重
  
  # 用于判断重复的关键字段（列表）
  # 当多个文件中有相同关键字段组合的记录时，只保留最新的
  key_fields:
    - "BatchNumber"
    - "Operation"
    - "machine"
    - "factory_source"  # 新增：工厂标识，防止跨工厂误去重
  
  # 用于判断"最新"的排序字段
  sort_field: "TrackOutTime"  # 通常使用报工时间
  
  # 排序方向：false表示降序（保留最大值/最新值），true表示升序（保留最小值/最早值）
  sort_ascending: false

# 测试配置
test:
  # 是否启用测试模式（仅读取部分数据）
  enabled: false  # 设置为true启用测试模式，false读取全部数据
  
  # 测试模式下读取的最大行数
  max_rows: 50000  # 仅读取前N行数据用于测试

# 增量处理配置
incremental:
  # 是否启用增量处理
  enabled: true  # 设置为true启用增量处理
  
  # 历史数据文件路径（用于增量合并）
  history_file: "C:\\Users\\huangk14\\OneDrive - Medtronic PLC\\CZ Production - 文档\\General\\POWER BI 数据源 V2\\30-MES导出数据\\publish\\MES_batch_report_latest.parquet"
  
  # 状态文件路径（记录已处理的记录）
  state_file: "C:\\Users\\huangk14\\OneDrive - Medtronic PLC\\CZ Production - 文档\\General\\POWER BI 数据源 V2\\30-MES导出数据\\publish\\etl_mes_state.json"
  
  # 用于生成唯一记录标识的字段（复合键）
  # 这些字段组合起来应该能唯一标识一条记录
  unique_key_fields:
    - "BatchNumber"
    - "Operation"
    - "machine"
    - "factory_source"  # 新增：工厂标识
    - "TrackOutTime"

# 分层架构配置（新增：仅用于新脚本）
layered_architecture:
  # 是否启用分层架构
  enabled: true  # 设置为true启用分层架构，false使用传统单文件输出
  
  # 系统和实体配置
  system:
    name: "MES"           # 系统名称
    entity: "batch_report" # 实体名称
  
  # 输出路径配置
  output:
    base_dir: "C:\\Users\\huangk14\\OneDrive - Medtronic PLC\\CZ Production - 文档\\General\\POWER BI 数据源 V2\\A1_ETL_Output"
    
    # 分层目录配置
    layers:
      processed: "01_PROCESSED"  # 清洗处理层
      publish: "02_PUBLISH"      # 发布消费层
      metadata: "03_METADATA"    # 元数据管理层
  
  # 记录级增量检测配置
  record_level_incremental:
    enabled: true
    hash_algorithm: "MD5"
    hash_fields:  # 用于计算记录哈希的字段
      - "BatchNumber"
      - "Operation"
      - "TrackOutTime"
  
  # 文件命名配置
  naming:
    incremental_prefix: "incremental"  # 增量文件前缀
    full_prefix: "mes_batch_report"    # 全量文件前缀
    latest_suffix: "latest"            # 最新文件后缀
  
  # 时间窗口（天）：只处理TrackOutTime在此时间窗口内的数据
  # 设置为0或null表示不限制时间窗口
  time_window_days: null  # 例如：30 表示只处理最近30天的数据
  
  # 全量刷新阈值（天）：如果距离上次处理时间超过此值，执行全量刷新
  # 设置为0或null表示不限制
  full_refresh_threshold_days: 90  # 90天未刷新则全量处理

# 运行时配置
runtime:
  # 处理失败时的行为
  on_error: "continue"  # continue 或 stop
