# 数据刷新脚本使用说明

## 📋 脚本简介

本项目提供两个主要的数据刷新脚本，分别应对**日常快速更新**和**系统全量维护**两种场景。

| 脚本文件名 | `refresh_core_data.bat` | `refresh_full_data.bat` |
| :--- | :--- | :--- |
| **中文名称** | **核心数据快速刷新** | **全量数据完整刷新** |
| **定位** | 日常高频使用 (Daily) | 系统维护/修复 (Maintenance) |
| **耗时** | 短 (仅增量更新) | 长 (全量/重建) |
| **数据范围** | 仅核心业务数据 (MES/SFC/SAP/Planner) | 所有数据 (含维度表、辅助表、历史数据) |

---

## 🚀 脚本详解

### 1️⃣ 核心数据快速刷新 (`refresh_core_data.bat`)

**适用场景：**
- 每日晨会前的数据更新
- 生产/质量数据的实时看板刷新
- 只需关注最新批次和检验记录时

**包含数据源：**
1. **SAP 工艺路线** (标准时间)
2. **SFC 批量报告** (批次产出)
3. **SFC 产品检验** (质量数据)
4. **MES 批量报告** (生产报工)
5. **Planner 任务** (任务状态)
6. **KPI 监控** (自动计算 SA/LT 指标并触发报警)

**运行模式：**
- **固定为增量刷新 (Incremental Mode)**
- 只处理新产生或变更的数据文件
- 速度极快

---

### 2️⃣ 全量数据完整刷新 (`refresh_full_data.bat`)

**适用场景：**
- 每周/每月的系统例行维护
- 基础数据变更（如新增节假日、修改工序映射表）
- 数据出现不一致，需要重置修复时
- 首次部署环境

**包含数据源 (共15步)：**
- **基础维度：** 日历 (Calendar)、节假日 (Holidays)、工序映射 (Operation Mapping)
- **SAP 扩展：** 工艺路线、实际工时、计划工时、工作日标志更新
- **SFC 全量：** 批量报告、在制品 (WIP)、维修记录 (Repair)、不合格品 (NC)、产品检验
- **MES 全量：** 批量报告
- **Planner：** 任务与标签
- **监控：** KPI 聚合与触发引擎

**运行模式：**
- **全量/覆盖模式**
- 会重建维度表，重新扫描所有历史文件
- 确保数据绝对一致

---

## 🛠️ 使用指南

### 方式1：双击运行
直接在文件夹中双击对应的 `.bat` 文件即可。

### 方式2：命令行运行
```powershell
# 日常使用：刷新核心数据
.\scripts\refresh_core_data.bat

# 维护使用：刷新所有数据
.\scripts\refresh_full_data.bat
```

---

## 🔍 故障排除

**Q: 运行脚本时提示“虚拟环境未检测到”？**
A: 脚本会自动尝试使用系统 Python。如果脚本运行出错，请确保你已创建并激活了 Python 虚拟环境 `.venv`。

**Q: `refresh_core_data.bat` 刷新后数据似乎没变？**
A: 该脚本是增量刷新。如果源文件没有新文件或修改日期未变更，脚本可能跳过处理。如果需要强制刷新，请使用 `refresh_full_data.bat`。

**Q: 刷新过程中某个步骤失败了怎么办？**
A: 
1. 脚本最后会显示日志文件路径（通常在 `shared_infrastructure\logs\`）。
2. 打开对应的日志文件查看详细错误信息。
3. 如果是网络或文件占用问题，稍后重试即可。

---

## 📞 技术支持

如遇到无法解决的问题，请联系数字化团队或查看 `docs/PROJECT_STRUCTURE_GUIDE.md` 获取更多技术细节。
