# Phase 2 ETLè¿ç§»æ€»ç»“æŠ¥å‘Š

## ğŸ“Š è¿ç§»æ¦‚è§ˆ

**è¿ç§»ç›®æ ‡ï¼š** å°†ç°æœ‰ETLè„šæœ¬è¿ç§»åˆ°æ–°çš„æ ‡å‡†åŒ–é¡¹ç›®æ¶æ„ï¼Œå®ç°é›†ä¸­åŒ–è·¯å¾„é…ç½®å’Œå…±äº«å·¥å…·å‡½æ•°ã€‚

**è¿ç§»èŒƒå›´ï¼š** 6ä¸ªETLè„šæœ¬ + é…ç½®æ–‡ä»¶ + æµ‹è¯•éªŒè¯

**å®Œæˆæ—¶é—´ï¼š** 2025å¹´12æœˆ3æ—¥

**è¿ç§»çŠ¶æ€ï¼š** âœ… **å®Œæˆ** (100%æµ‹è¯•é€šè¿‡)

---

## ğŸ—ï¸ æ¶æ„é‡æ„æˆæœ

### ç›®å½•ç»“æ„æ ‡å‡†åŒ–

**é‡æ„å‰ï¼š**
```
10-SAæŒ‡æ ‡/13-SAæ•°æ®æ¸…æ´—/
â”œâ”€â”€ 03_é…ç½®æ–‡ä»¶/config/
â”œâ”€â”€ 06_æ—¥å¿—æ–‡ä»¶/
â”œâ”€â”€ etl_utils.py
â””â”€â”€ etl_*.py (åˆ†æ•£çš„è„šæœ¬)
```

**é‡æ„åï¼š**
```
shared_infrastructure/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ paths.yaml
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ etl_utils.py
â”‚   â””â”€â”€ path_resolver.py
â””â”€â”€ tests/
    â”œâ”€â”€ test_*_migration.py
    â””â”€â”€ ...

data_pipelines/sources/{source}/
â”œâ”€â”€ etl/
â”‚   â””â”€â”€ etl_dataclean_*.py
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config_*.yaml
â”œâ”€â”€ state/
â”œâ”€â”€ tests/
â””â”€â”€ docs/

business_domains/
â”œâ”€â”€ test_data/
â”œâ”€â”€ output_data/
â””â”€â”€ metadata/
```

### Pythonæ¨¡å—å‘½åä¿®å¤

**é—®é¢˜ï¼š** ç›®å½•ååŒ…å«è¿å­—ç¬¦(`-`)ï¼Œè¿åPythonæ¨¡å—å‘½åè§„èŒƒ
**è§£å†³æ–¹æ¡ˆï¼š** é‡å‘½åç›®å½•
- `shared-infrastructure` â†’ `shared_infrastructure`
- `data-pipelines` â†’ `data_pipelines`  
- `business-domains` â†’ `business_domains`

---

## ğŸ”§ è·¯å¾„è§£æç³»ç»Ÿ

### PathResolverç±»è®¾è®¡

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- é›†ä¸­åŒ–è·¯å¾„é…ç½®ç®¡ç†
- æ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„åŠ¨æ€è§£æ
- å˜é‡æ›¿æ¢å’Œä¸Šä¸‹æ–‡æ„ŸçŸ¥è·¯å¾„è§£æ
- é…ç½®æ–‡ä»¶å’ŒçŠ¶æ€æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„è§£æ

**å…³é”®æ–¹æ³•ï¼š**
```python
get_config_path(script_name, source, base_dir)  # é…ç½®æ–‡ä»¶è·¯å¾„
get_state_path(script_name, source, base_dir)   # çŠ¶æ€æ–‡ä»¶è·¯å¾„
get_log_path(source)                            # æ—¥å¿—æ–‡ä»¶è·¯å¾„
get_path(category, name, source, department)    # é€šç”¨è·¯å¾„è§£æ
```

### é…ç½®æ–‡ä»¶ç»“æ„

**paths.yamlé…ç½®ï¼š**
```yaml
config_paths:
  sap_routing: ../config/config_sap_routing.yaml
  sfc_product_inspection: ../config/config_sfc_product_inspection.yaml
  sfc_batch_report: ../config/config_sfc_batch_report.yaml
  sfc_team_passrate: ../config/config_sfc_team_passrate.yaml
  mes_batch_report: ../config/config_mes_batch_report.yaml

state_paths:
  sap_routing: ../state/sap_routing_state.json
  sfc_product_inspection: ../state/sfc_product_inspection_state.json
  # ... å…¶ä»–çŠ¶æ€è·¯å¾„

log_paths:
  sap: logs/etl_sap.log
  sfc: logs/etl_sfc.log
  mes: logs/etl_mes.log
```

---

## ğŸ“‹ ETLè„šæœ¬è¿ç§»è¯¦æƒ…

### è¿ç§»æ¨¡å¼

**æ ‡å‡†åŒ–å¯¼å…¥æ¨¡å¼ï¼š**
```python
# åŠ¨æ€æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(os.path.dirname(os.path.dirname(current_dir)))
sys.path.insert(0, project_root)

# å¯¼å…¥å…±äº«åŸºç¡€è®¾æ–½å·¥å…·å‡½æ•°
from shared_infrastructure.utils.etl_utils import (
    setup_logging,
    load_config,
    save_to_parquet,
    read_sharepoint_excel
)
from shared_infrastructure.utils.path_resolver import (
    get_config_path,
    get_log_path,
    get_state_path,
    get_path_resolver
)

# é…ç½®è·¯å¾„
CONFIG_PATH = get_config_path("script_name", "source", os.path.dirname(os.path.abspath(__file__)))
LOG_PATH = get_log_path("source")
STATE_PATH = get_state_path("script_name", "source", os.path.dirname(os.path.abspath(__file__)))
```

### è¿ç§»è„šæœ¬æ¸…å•

| æ•°æ®æº | è„šæœ¬åç§° | çŠ¶æ€ | æµ‹è¯•ç»“æœ |
|--------|----------|------|----------|
| SAP | etl_dataclean_sap_routing.py | âœ… å®Œæˆ | 3/3 é€šè¿‡ |
| SFC | etl_dataclean_sfc_product_inspection.py | âœ… å®Œæˆ | 3/3 é€šè¿‡ |
| SFC | etl_dataclean_sfc_batch_report.py | âœ… å®Œæˆ | 3/3 é€šè¿‡ |
| SFC | etl_dataclean_sfc_team_passrate.py | âœ… å®Œæˆ | 3/3 é€šè¿‡ |
| MES | etl_dataclean_mes_batch_report.py | âœ… å®Œæˆ | 3/3 é€šè¿‡ |
| MES | etl_dataclean_mes_batch_report_partitions.py | âœ… å®Œæˆ | 3/3 é€šè¿‡ |

### é…ç½®æ–‡ä»¶è¿ç§»

**ç§»åŠ¨çš„é…ç½®æ–‡ä»¶ï¼š**
- `config_sap_routing.yaml` â†’ `data_pipelines/sources/sap/config/`
- `config_sfc_product_inspection.yaml` â†’ `data_pipelines/sources/sfc/config/`
- `config_sfc_batch_report.yaml` â†’ `data_pipelines/sources/sfc/config/`
- `config_sfc_team_passrate.yaml` â†’ `data_pipelines/sources/sfc/config/`
- `config_mes_batch_report.yaml` â†’ `data_pipelines/sources/mes/config/`

---

## ğŸ§ª æµ‹è¯•éªŒè¯ä½“ç³»

### æµ‹è¯•è„šæœ¬æ¶æ„

**æ¯ä¸ªè¿ç§»è„šæœ¬å¯¹åº”æµ‹è¯•æ–‡ä»¶ï¼š**
```python
def test_{source}_script_import():
    """æµ‹è¯•è„šæœ¬å¯¼å…¥æ˜¯å¦æ­£å¸¸"""
    
def test_{source}_path_resolution():
    """æµ‹è¯•è·¯å¾„è§£ææ˜¯å¦æ­£ç¡®"""
    
def test_{source}_script_functionality():
    """æµ‹è¯•åŸºæœ¬åŠŸèƒ½æ˜¯å¦æ­£å¸¸"""
```

### æµ‹è¯•ç»“æœæ±‡æ€»

**æ€»ä½“æµ‹è¯•é€šè¿‡ç‡ï¼š100% (18/18)**

- **å¯¼å…¥æµ‹è¯•ï¼š** 6/6 é€šè¿‡ âœ…
- **è·¯å¾„è§£ææµ‹è¯•ï¼š** 6/6 é€šè¿‡ âœ…
- **åŠŸèƒ½æµ‹è¯•ï¼š** 6/6 é€šè¿‡ âœ…

**è¯¦ç»†æµ‹è¯•ç»“æœï¼š**
```
SAPè„šæœ¬è¿ç§»: 3/3 é€šè¿‡ âœ…
SFCäº§å“æ£€éªŒè„šæœ¬è¿ç§»: 3/3 é€šè¿‡ âœ…
SFCæ‰¹é‡æŠ¥å‘Šè„šæœ¬è¿ç§»: 3/3 é€šè¿‡ âœ…
SFCå›¢é˜Ÿé€šè¿‡ç‡è„šæœ¬è¿ç§»: 3/3 é€šè¿‡ âœ…
MESæ‰¹é‡æŠ¥å‘Šè„šæœ¬è¿ç§»: 3/3 é€šè¿‡ âœ…
MESå¢é‡å¤„ç†è„šæœ¬è¿ç§»: 3/3 é€šè¿‡ âœ…
```

---

## ğŸ” è§£å†³çš„æŠ€æœ¯é—®é¢˜

### 1. Pythonå¯¼å…¥é—®é¢˜
**é—®é¢˜ï¼š** è¿å­—ç¬¦ç›®å½•åå¯¼è‡´ImportError
**è§£å†³ï¼š** é‡å‘½åä¸ºä¸‹åˆ’çº¿ï¼Œæ›´æ–°æ‰€æœ‰å¯¼å…¥è·¯å¾„

### 2. è·¯å¾„è§£æé”™è¯¯
**é—®é¢˜ï¼š** é…ç½®æ–‡ä»¶è·¯å¾„è§£æé”™è¯¯ï¼ŒæŒ‡å‘é”™è¯¯ç›®å½•
**è§£å†³ï¼š** ä¿®æ”¹PathResolver.get_path()æ–¹æ³•ï¼Œå¯¹config_pathså’Œstate_pathsä¿æŒåŸå§‹å­—ç¬¦ä¸²ï¼Œåœ¨å…·ä½“æ–¹æ³•ä¸­è§£æ

### 3. åŠ¨æ€è·¯å¾„è¦†ç›–
**é—®é¢˜ï¼š** MESè„šæœ¬ä¸­get_base_dir()è¦†ç›–è¿ç§»çš„BASE_DIRè®¾ç½®
**è§£å†³ï¼š** ç§»é™¤é‡å¤çš„BASE_DIRèµ‹å€¼ï¼Œç¡®ä¿è¿ç§»çš„è·¯å¾„è®¾ç½®ç”Ÿæ•ˆ

### 4. æµ‹è¯•ä¸Šä¸‹æ–‡é—®é¢˜
**é—®é¢˜ï¼š** æµ‹è¯•è„šæœ¬è°ƒç”¨è·¯å¾„è§£æå™¨æ—¶ä¸Šä¸‹æ–‡é”™è¯¯
**è§£å†³ï¼š** ä¿®æ”¹æµ‹è¯•è„šæœ¬ä½¿ç”¨ETLè„šæœ¬é¢„è®¡ç®—çš„CONFIG_PATHï¼Œè€Œéé‡æ–°è®¡ç®—

---

## ğŸ“ˆ è¿ç§»æ”¶ç›Š

### 1. æ¶æ„æ ‡å‡†åŒ–
- âœ… ç»Ÿä¸€çš„ç›®å½•ç»“æ„å’Œå‘½åè§„èŒƒ
- âœ… æ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œæ¨¡å—åŒ–è®¾è®¡
- âœ… ç¬¦åˆPythonæœ€ä½³å®è·µçš„æ¨¡å—ç»“æ„

### 2. è·¯å¾„ç®¡ç†ä¼˜åŒ–
- âœ… é›†ä¸­åŒ–è·¯å¾„é…ç½®ï¼Œå‡å°‘ç¡¬ç¼–ç 
- âœ… åŠ¨æ€è·¯å¾„è§£æï¼Œæ”¯æŒç›¸å¯¹å’Œç»å¯¹è·¯å¾„
- âœ… ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„è·¯å¾„è§£ææœºåˆ¶

### 3. å¯ç»´æŠ¤æ€§æå‡
- âœ… å…±äº«å·¥å…·å‡½æ•°ç»Ÿä¸€ç®¡ç†
- âœ… æ ‡å‡†åŒ–å¯¼å…¥æ¨¡å¼ï¼Œæ˜“äºç»´æŠ¤
- âœ… å®Œæ•´çš„æµ‹è¯•éªŒè¯ä½“ç³»

### 4. æ‰©å±•æ€§å¢å¼º
- âœ… æ–°ETLè„šæœ¬å¯å¿«é€Ÿåº”ç”¨ç›¸åŒæ¨¡å¼
- âœ… çµæ´»çš„è·¯å¾„é…ç½®æ”¯æŒå¤šç§éƒ¨ç½²åœºæ™¯
- âœ… æ¨¡å—åŒ–è®¾è®¡ä¾¿äºåŠŸèƒ½æ‰©å±•

---

## ğŸ”„ åç»­å»ºè®®

### çŸ­æœŸä»»åŠ¡ (Phase 3)
1. **çŠ¶æ€æ–‡ä»¶ç»„ç»‡**
   - ç»Ÿä¸€ç®¡ç†ETLçŠ¶æ€æ–‡ä»¶
   - å®ç°çŠ¶æ€æ–‡ä»¶å¤‡ä»½å’Œæ¢å¤æœºåˆ¶
   - æ·»åŠ çŠ¶æ€æ–‡ä»¶æ¸…ç†ç­–ç•¥

2. **ç«¯åˆ°ç«¯æµ‹è¯•**
   - æ‰§è¡Œå®Œæ•´æ•°æ®æµç¨‹æµ‹è¯•
   - éªŒè¯æ‰€æœ‰è„šæœ¬åœ¨å®é™…æ•°æ®å¤„ç†ä¸­çš„æ­£ç¡®æ€§
   - æ€§èƒ½åŸºå‡†æµ‹è¯•

### ä¸­æœŸä»»åŠ¡ (Phase 4)
1. **è·¨æºç¼–æ’å™¨**
   - åˆ›å»ºç»Ÿä¸€çš„ETLæ‰§è¡Œè°ƒåº¦å™¨
   - å®ç°ä¾èµ–ç®¡ç†å’Œæ‰§è¡Œé¡ºåºæ§åˆ¶
   - æ·»åŠ æ‰§è¡Œç›‘æ§å’Œé”™è¯¯å¤„ç†

2. **ç›‘æ§å’Œæ—¥å¿—å¢å¼º**
   - ç»Ÿä¸€æ—¥å¿—æ ¼å¼å’Œæ”¶é›†
   - æ·»åŠ æ‰§è¡ŒæŒ‡æ ‡ç›‘æ§
   - å®ç°å‘Šè­¦æœºåˆ¶

### é•¿æœŸä»»åŠ¡ (Phase 5)
1. **éƒ¨ç½²è‡ªåŠ¨åŒ–**
   - åˆ›å»ºéƒ¨ç½²è„šæœ¬å’Œé…ç½®
   - å®ç°ç‰ˆæœ¬ç®¡ç†å’Œå›æ»šæœºåˆ¶
   - æ·»åŠ ç¯å¢ƒé…ç½®ç®¡ç†

2. **æ–‡æ¡£å®Œå–„**
   - ç”¨æˆ·æ“ä½œæ‰‹å†Œ
   - å¼€å‘è€…æŒ‡å—
   - æ•…éšœæ’é™¤æ–‡æ¡£

---

## ğŸ“ ç»éªŒæ€»ç»“

### æˆåŠŸå› ç´ 
1. **æ¸è¿›å¼è¿ç§»ç­–ç•¥** - å…ˆå»ºç«‹æ¨¡æ¿ï¼Œå†æ‰¹é‡åº”ç”¨
2. **å®Œæ•´æµ‹è¯•éªŒè¯** - æ¯ä¸ªè„šæœ¬éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•éªŒè¯
3. **é—®é¢˜é©±åŠ¨ä¼˜åŒ–** - é‡åˆ°é—®é¢˜åŠæ—¶è°ƒæ•´æ–¹æ¡ˆ
4. **æ–‡æ¡£åŒæ­¥æ›´æ–°** - åŠæ—¶è®°å½•è¿ç§»è¿‡ç¨‹å’Œå†³ç­–

### å…³é”®æŠ€æœ¯å†³ç­–
1. **PathResolverè®¾è®¡** - æ”¯æŒç›¸å¯¹è·¯å¾„çš„åŠ¨æ€è§£æ
2. **å¯¼å…¥æ¨¡å¼æ ‡å‡†åŒ–** - ç»Ÿä¸€çš„sys.pathæ’å…¥ç­–ç•¥
3. **æµ‹è¯•æ¶æ„è®¾è®¡** - ç‹¬ç«‹çš„æµ‹è¯•è„šæœ¬éªŒè¯è¿ç§»ç»“æœ

### å¯å¤ç”¨æ¨¡å¼
1. **ç›®å½•ç»“æ„æ¨¡å¼** - å¯åº”ç”¨äºå…¶ä»–é¡¹ç›®
2. **è·¯å¾„è§£ææ¨¡å¼** - æ”¯æŒå¤šç§éƒ¨ç½²åœºæ™¯
3. **è¿ç§»æµ‹è¯•æ¨¡å¼** - ç¡®ä¿è¿ç§»è´¨é‡çš„æ–¹æ³•è®º

---

**Phase 2 ETLè¿ç§»å·²æˆåŠŸå®Œæˆï¼** ğŸ‰

---

## ğŸ“š Phase 2.5: æ–‡æ¡£ç³»ç»Ÿè¿ç§»

### è¿ç§»æ¦‚è§ˆ
**è¿ç§»ç›®æ ‡ï¼š** å°†MkDocsæ–‡æ¡£ç³»ç»Ÿä» `92-è¯´æ˜æ–‡æ¡£` è¿ç§»åˆ°æ ‡å‡†åŒ–çš„ `documentation/` ç›®å½•

**è¿ç§»èŒƒå›´ï¼š** å®Œæ•´çš„MkDocsç³»ç»Ÿ (217ä¸ªæ–‡ä»¶)
- é…ç½®æ–‡ä»¶ï¼šmkdocs.yml, requirements.txt
- æ–‡æ¡£å†…å®¹ï¼šdocs/ (81é¡¹), reference/ (12é¡¹)
- éƒ¨ç½²è„šæœ¬ï¼š5ä¸ª.batæ–‡ä»¶
- é™æ€ç½‘ç«™ï¼šsite/ (114é¡¹)

**å®Œæˆæ—¶é—´ï¼š** 2025å¹´12æœˆ3æ—¥
**è¿ç§»çŠ¶æ€ï¼š** âœ… **å®Œæˆ**

### è¿ç§»æˆæœ
- âœ… æ‰€æœ‰217ä¸ªæ–‡ä»¶æˆåŠŸå¤åˆ¶åˆ°æ–°ä½ç½®
- âœ… MkDocsæ„å»ºæµ‹è¯•é€šè¿‡ (exit code 0)
- âœ… æ–‡æ¡£å¯¼èˆªç»“æ„å®Œæ•´ä¿ç•™
- âœ… åŸå§‹æ–‡ä»¶å¤¹å·²å½’æ¡£ä¸º `92-è¯´æ˜æ–‡æ¡£_ARCHIVE_20251203`
- âœ… Gitæ—¶é—´æˆ³è­¦å‘Šå·²æ­£ç¡®é…ç½®å¤„ç†

### æŠ€æœ¯ç»†èŠ‚
- **ç­–ç•¥ï¼š** ä¿æŒç°æœ‰æ–‡æ¡£ç»“æ„ä¸å˜ï¼Œé¿å…ç ´åå†…éƒ¨é“¾æ¥
- **é…ç½®ï¼š** mkdocs.ymlä¸­çš„ `enable_git_follow: false` å·²æ­£ç¡®è®¾ç½®
- **éªŒè¯ï¼š** é€šè¿‡ `mkdocs build --quiet` éªŒè¯æ„å»ºæˆåŠŸ

### MkDocs æ ‡å‡†åŒ–é‡æ„
**é‡æ„ç›®æ ‡ï¼š** å°†æ–‡æ¡£ç³»ç»Ÿè°ƒæ•´ä¸ºMkDocsæœ€ä½³å®è·µ

**é‡æ„å†…å®¹ï¼š**
- âœ… ç§»åŠ¨ `mkdocs.yml` åˆ°é¡¹ç›®æ ¹ç›®å½• (MkDocsæ ‡å‡†)
- âœ… æ·»åŠ  `docs_dir: documentation/docs` å’Œ `site_dir: site` é…ç½®
- âœ… åˆ›å»º `.gitignore` æ–‡ä»¶ï¼Œæ’é™¤ç”Ÿæˆçš„ `site/` å†…å®¹
- âœ… éªŒè¯ä»é¡¹ç›®æ ¹ç›®å½•çš„æ„å»ºæµç¨‹æ­£å¸¸å·¥ä½œ
- âœ… å®ç°æºæ–‡ä»¶ä¸æ„å»ºäº§ç‰©çš„å®Œå…¨åˆ†ç¦»

**æœ€ç»ˆç»“æ„ï¼š**
```
mkdocs.yml              # é¡¹ç›®æ ¹ç›®å½• (MkDocsæ ‡å‡†)
.gitignore              # Gitå¿½ç•¥è§„åˆ™
site/                   # ç”Ÿæˆçš„é™æ€ç½‘ç«™ (é¡¹ç›®æ ¹ç›®å½•ï¼Œgitignored)
documentation/
â”œâ”€â”€ docs/              # æºmarkdownæ–‡ä»¶
â”œâ”€â”€ reference/         # å‚è€ƒèµ„æ–™
â””â”€â”€ *.bat              # éƒ¨ç½²è„šæœ¬
```

---

*æœ¬è¿ç§»ä¸ºåç»­çš„ETLç³»ç»Ÿæ‰©å±•å’Œç»´æŠ¤å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚*
