# 2025-12-21 (Day Log)

## Goals

- Refine SA/LT calculation logic and make it consistent between database view and KPI aggregation.
- Downstream operation-level SA flags (`IsOverdue`/`IsOnTime`) into SQLite view for Power BI consumption.
- Ensure weekly GLOBAL SA is available for A3 trigger, without needing daily SA.

## Changes

- Extended `v_mes_metrics` to include `Tolerance(d)` (8h), `IsOverdue`, `IsOnTime` based on `PT(d)` vs `ST(d) + 8h`.
- Synced `scripts/update_db_view.py` view DDL with schema so refresh applies the same definition.
- Updated `etl_kpi_aggregation.py` to calculate weekly GLOBAL SA from `v_mes_metrics.IsOnTime` (operation-level) and store into `KPI_Data`.
- Disabled daily SA aggregation by default; kept only weekly `KPI_Id=2, Tag='GLOBAL'` for triggers.
- Reduced risk of KPI refresh by deleting only recomputed KPI rows instead of truncating `KPI_Data`.

## Commands / Runs

- Rebuilt view:
  - `python scripts/update_db_view.py`
- Recomputed KPIs:
  - `python data_pipelines/monitoring/etl/etl_kpi_aggregation.py`

## Outputs / Artifacts

- SQLite DB:
  - `data_pipelines/database/mddap_v2.db` (`KPI_Data`, view `v_mes_metrics`)
- Exported reports:
  - `data_pipelines/monitoring/output/kpi_global_matrix.csv`
  - `data_pipelines/monitoring/output/pareto_top_matrix.csv`
  - `data_pipelines/monitoring/output/kpi_trigger_results.csv` / `.tsv`

## Validation

- Confirmed `v_mes_metrics` contains new columns: `Tolerance(d)`, `IsOverdue`, `IsOnTime`.
- Confirmed weekly SA exists in `KPI_Data`:
  - `KPI_Id=2` tag counts: only `('GLOBAL', 77)` after rerun.

## Decisions

- Keep both `IsOverdue` and `IsOnTime` in view for clarity and easier aggregation.
- Only weekly SA is needed for A3 triggers; daily SA is not generated by default.
- `Tag='GLOBAL'` denotes aggregation scope (all plants) while `KPI_Id=2` denotes SA KPI.

## Next

- (Optional) Add a dedicated SA view if `v_mes_metrics` needs to remain stable for other consumers.
- Run deeper validation on selected weeks/batches:
  - Recompute weekly SA from `v_mes_metrics` and compare to `KPI_Data`.
  - Sample-check overdue logic for a few operations.
