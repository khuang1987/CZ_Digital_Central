# Labor EH Analysis (工时分析) 报表逻辑定义

本文档详细定义了 Production Dashboard 中 **Labor EH（工时效率）** 分析页面的数据逻辑、界面元素及交互行为。

## 1. 页面元素定义 (UI Elements)

### 1.1 KPI 核心指标卡 (KPI Tiles)
所有卡片均采用“大字显示主数据 + 底边小字显示增减/对比”的丰富布局。对比内容包含：增减绝对值、同比/环比比例（YoY/PoP %）。

-   **Card 1: 平均工时 (Average Hours)**
    -   **逻辑**: `SUM(EarnedLaborTime) / 统计周期内工作日天数`。
    -   **卡片指标**:
        -   **主数据**: 当前平均工时。
        -   **次级数据**: 月目标平均工时、当前值与目标的差值、同比增减比例。

-   **Card 2: 工作日进度 (Days Progress)**
    -   **逻辑**: 统计 `dim_calendar` 中的 `is_workday = 1` 记录。
    -   **卡片指标**:
        -   **主数据**: 当前已度过的工作日数量。
        -   **次级数据**: 当月总计划工作日数量、时间进度百分比 (Progress %)。
        -   **UI 建议**: 增加横向进度条。

-   **Card 3: 选定周期总工时 (Period Total EH)**
    -   **逻辑**: 根据筛选器动态变更。若选择了 2 个月，则显示 2 个月的总工时。
    -   **卡片指标**:
        -   **主数据**: 累计总工时。
        -   **次级数据**: 周期目标总工时、当前值与目标的差值、同比增减比例。

-   **Card 4: 财年累计工时 (FY Total EH)**
    -   **逻辑**: 截止当前日期的本财年（FY）所有工时总和。
    -   **卡片指标**:
        -   **主数据**: 财年累计总工时 (YTD Total EH)。
        -   **次级数据**: 财年总目标 (FY Plan)、完成进度百分比。

### 1.2 统计粒度切换 (Granularity Controls) 与 导航
- **快捷切换**: 选项卡样式的快捷切换按钮（天/周/月/年），点击后全局图表联动。
- **布局分区**:
    - **首屏 (Fold 1 - Overview)**: 4个核心 KPI 磁贴 + 全局工厂对比趋势。
    - **二屏 (Fold 2 - Diagnostic)**: 异常分析 (Anomaly Detection) + 区域效率排行榜。
    - **三屏 (Fold 3 - Raw Data)**: 详细订单流水表。

### 1.2 页面架构：三段式叙事布局 (Three-Tier Narrative)
依据制造业数字化转型最佳实践，页面采用纵向流式布局，由浅入深引导管理决策：

1.  **第一屏：执行概览 (Fold 1 - Executive Overview)**
    - **目标**: 3秒内传达状态。
    - **元素**: 核心 KPI 指标卡 (Actual vs Target) + 全局工时趋势波动图。
    - **逻辑**: 使用颜色（红/绿）直观呈现达成率。

2.  **第二屏：诊断分析 (Fold 2 - Diagnostic Analysis)**
    - **目标**: 回答“为什么不达标？”。
    - **元素**: 
        - **异常探测器 (Anomaly Explorer)**: 列出偏差值 >20% 的特定产品/日期。
        - **区域贡献度排行榜 (Leaderboard)**: 展示各车间/工区的 EH 产出效率分布，驱动内部良性对标。
    - **逻辑**: 通过多维下钻 (Drill-down) 定位 root cause。

3.  **第三屏：明细追踪 (Fold 3 - Operational Detail)**
    - **目标**: 闭环追踪。
    - **元素**: 订单明细表 + 关键物料追踪。
    - **逻辑**: 支持导出 Excel 供一线班组使用。

---

## 2. 行业最佳实践 (Industry Best Practices)

### 2.1 视觉层次与色彩管理
-   **红绿灯逻辑**: 偏差 < 5% (绿色), 5%-20% (黄色), >20% (红色)。
-   **信息密度**: 第一屏保持低密度，高对比；二、三屏逐步提高信息密度。

### 2.2 实时性与交互
-   **异常穿透**: 点击趋势图中的“红色离群点”，页面平滑滚动至第二屏并过滤出该日期的异常细节。
-   **联动控制**: 筛选器（工厂/计划组）全页面图表实时更新，平均响应时间 < 2s。
**交互**: 点击切换后，下方的趋势图 X 轴应随之改变粒度，KPI 卡片的对比周期也应同步适配。

### 1.3 核心分析主体 (Main Analysis Body)

为了满足从宏观到微观的多维度审计需求，主体部分分为三个核心板块：

#### A. 核心趋势图 (Labor Trend Chart)
-   **维度切换 (Drill-down/up)**:
    -   **年/季度视图**: 展示宏观年度达成情况。
    -   **月视图**: 展示各月波动。
    -   **天视图 (默认)**: 展示每日工时累计与 **Target（目标线）** 的对比。
-   **交互**: 
    -   双击柱状图可自动下钻至下一级粒度（如点击一月下钻到该月各周）。
    -   鼠标悬停显示详细数据提示 (Tooltip)。

#### B. 区域/工序速查表 (Area/Operation Summary)
-   **功能**: 用于快速定位哪些区域是“工时大户”。
-   **列定义**: 区域名称、工序总数、累计工时、占比、平均每单工时。
-   **排序**: 默认按累计工时降序排列，直观发现异常或核心产线。

#### C. 日期明细与报工审计 (Batch Reporting Details)
-   **功能**: 最底层的原始数据核查。
-   **内容**:
    -   按日期分组，展示每日的报工批次。
    -   明细信息：报工时间、订单号、材料编码、工序描述、Earned EH、操作人员（如有）。
-   **搜索**: 支持直接输入订单号或材料号在明细中快速过滤。

### 1.4 额外建议 (Professional Recommendations)
为了挖掘数据背后的价值，建议增加以下两个组件：

1.  **Top N 贡献榜 (Material/Order Impact)**:
    *   展示贡献工时最多的 **前 10 个物料** 或 **前 10 个订单**。
    *   *价值*：识别核心型号，判断是否存在个别物料工时定额异常。
2.  **工时分布热力图 (Efficiency Heatmap)**:
    *   按星期和小时（或早中晚班）展示报工密集度。
    *   *价值*：识别产线节拍和报工规律，优化排班。
3.  **数据质量看板 (Data Health Check)**:
    *   提示是否存在“零工时订单”或“工序映射失败”的存疑数据。

---

## 2. 筛选交互逻辑 (Filtering & Interaction)

### 2.1 筛选器分类与功能
为了保持界面简洁并提高效率，筛选器分为以下两大类：

#### A. 时间筛选 (Time Filters)
-   **财年 (Fiscal Year)**: 支持单选。点击年分后，下方月份与周自动联动。
-   **财月 (Fiscal Month)**: 建议使用 **平铺式微缩按钮 (Segmented/Chips)** 而非下拉框，方便一键触达。
-   **财周 (Fiscal Week)**: 联动显示当前财月下的所有周，标记当前周。
-   **联动逻辑 (Linkage)**: 
    - 修改财年 -> 刷新财月列表 -> 默认选择最新月份。
    - 修改财月 -> 刷新财周列表 -> 默认选择第一周或该月所有周数据。

#### B. 生产/业务筛选 (Production Filters)
-   **工厂 (Plant)**: 顶层物理位置筛选，支持 **9997 (康辉)** 和 **1303 (常州运营)**。
-   **区域 (Area)**: 根据工厂联动。建议支持 **多选 (Multiselect)**，以便对比不同产线。
-   **产品类型 (Product Type)**: 筛选特定品类（如：脊柱、创伤等）。
-   **工序 (Operation Name)**: 最细粒度筛选。由于工序较多，必须支持 **搜索过滤 (Searchable Select)**。

### 2.2 专家建议 (Recommended Enhancements)
1.  **全局状态同步 (Global Reset)**: 增加“恢复默认”按钮，点击后自动定位到“最新数据财周+全选区域”。
2.  **多选标签化 (Tag Cloud for Selections)**: 当多选区域或工序时，在筛选框下方显示已选标签，方便快速删除。
3.  **联动加载动画 (Skeleton Selectors)**: 在联动加载（如选完工厂加载区域）时，下拉框显示骨架屏或 Loading 状态，避免点击空白。
4.  **智能联想搜索**: 产品类型和工序筛选器支持首字母或拼音搜索。

### 2.3 默认与初始化逻辑
- **首次加载**:
    - 获取系统当前时间对应的财历。
    - 若数据库无最新日期数据，则自动定位到数据库中 `MAX(date)` 的所在周。
    - 统计粒度默认设为“周 (Week)”。

---

## 3. 数据关联与计算逻辑 (Data Mapping & Calculation)

### 3.1 核心数据源
- **主表**: `raw_sap_labor_hours` (存储 SAP 抽点工时记录)。
- **维度表 - 日历**: `dim_calendar` (提供财年/月/周映射)。
- **维度表 - 目标**: `dim_production_targets` (存储每日计划工时及工作日标记)。
- **ETL Script**: `etl_production_targets.py` 负责将 Excel 计划工时同步至 SQL Server。

### 3.2 报表交互与粒度逻辑
- **默认视图**: 首次加载自动定位至 **当前财月 (Current Fiscal Month)**。
- **灵活粒度**: 支持 **周 (Week)、月 (Month)、年 (Year)** 以及 **自定义 (Custom)** 范围切换。
  - **年视图**: 趋势图按 **财月** 聚合汇总。
  - **月/周视图**: 趋势图按 **日期** 展示每日数值。
- **趋势图渲染 (Trend Chart Rendering)**:
  - **缩放引擎**: 动态计算 `maxVal = Math.max(...AllActualAndTarget, 100) * 1.1`，确保图表始终占满视图且留有余量。
  - **颜色逻辑**: 实际 EH >= 目标 EH 时显示 **Medtronic Blue** 渐变；低于目标时显示 **Red** 告警。
  - **目标线**: 采用虚线（Ghost Target Bar）渲染，直观展示每日达成缺口。
- **自定义范围**: 支持自由选择起止日期，不限财历边界。
- **API 增强**: 后端根据 `granularity` 参数动态调整时间窗口起始值，并计算同比 YTD 指标。

### 3.3 关联与映射逻辑
- **时间关联**: `raw_sap_labor_hours.PostingDate = dim_calendar.date`
- **目标关联**: `raw_sap_labor_hours.PostingDate = dim_production_targets.Date`
- **工序区域映射**:
  `CAST(raw_sap_labor_hours.Operation AS NVARCHAR(100)) = CAST(dim_operation_mapping.operation_name AS NVARCHAR(100))`
  > [!IMPORTANT]
  > 对于工序字段，必须显式进行 `NVARCHAR` 类型转换。SAP 原生数据中工序 ID 可能被识别为数字，导致与映射表中的中文描述关联失败。

### 3.4 穿透与导出
- **明细穿透**: 支持在 Fold 3 中查看 top 100 条原始报工记录。
- **CSV 导出**: 允许用户一键导出当前过滤条件下的所有明细流水，用于二次审计。

### 3.5 计算公式
- **Total EH**: `SUM(EarnedLaborTime)`
- **Avg Daily EH**: `SUM(EarnedLaborTime) / COUNT(DISTINCT PostingDate)`

---

## 4. 异常处理 (Error Handling)
- **无数据状态**: 如果选定周内无数据，KPI 应显示 `0` 或 `-`，图表应显示“暂无数据 (No Data Available)”。
- **API 超时**: 增加 Loading 动画，超时后提示“数据库连接繁忙”。
