# 标准时间表计算逻辑实现总结

## 实现概述

已按照要求完成标准时间表的合并和计算逻辑修改：

### 1. convert_standard_time.py 修改

**功能**：在转换时合并两个标准时间表，并计算单位时间

**关键逻辑**：
1. **读取Routing表**：
   - 处理Quantity字段（默认值1）
   - 根据Unit (Machine)和Unit (Labor)判断单位（通常是"S"秒）
   - 计算单位时间：
     - Machine_per_unit_h = (Machine / Quantity) / 3600（如果单位是秒）
     - Labor_per_unit_h = (Labor / Quantity) / 3600（如果单位是秒）
   - 计算Effective Time (h)：如果Machine > 0用Machine，否则用Labor

2. **读取机加工清单表**：
   - 处理OEE字段（默认值0.77）
   - 处理调试时间字段（单位：小时）

3. **合并两个表**：
   - 匹配键：CFN、Operation、Group
   - 合并字段：OEE、调试时间、备注（如果存在）
   - 重命名调试时间为"Setup Time (h)"

4. **保存为Parquet**：
   - 输出文件：`publish/标准时间表_合并.parquet`
   - 包含字段：CFN、Operation、Group、Effective Time (h)、OEE、Setup Time (h)、备注等

### 2. ETL代码修改

#### etl_sa.py
- `merge_standard_time()`：从合并后的parquet文件读取，直接使用已计算好的Effective Time (h)
- 移除Effective Time计算逻辑（已在转换时计算好）
- 更新配置：`standard_time_path`指向合并后的parquet文件

#### etl_sfc.py
- `merge_standard_time_sfc()`：从合并后的parquet文件读取
- 支持按CFN、Operation、Group匹配（如果SFC有Group字段）
- 如果没有Group字段，则按CFN、Operation匹配

### 3. 配置文件更新

**config.yaml** 和 **config_sfc.yaml**：
```yaml
source:
  standard_time_path: "publish/标准时间表_合并.parquet"
```

## 计算逻辑说明

### Effective Time (h) 计算
```
如果Unit (Machine) == "S":
    Machine_per_unit_h = (Machine / Quantity) / 3600
否则:
    Machine_per_unit_h = Machine / Quantity

如果Unit (Labor) == "S":
    Labor_per_unit_h = (Labor / Quantity) / 3600
否则:
    Labor_per_unit_h = Labor / Quantity

Effective Time (h) = Machine_per_unit_h if Machine > 0 else Labor_per_unit_h
```

### ST(d) 计算
```
ST(d) = (Setup Time (h) + 数量 × Effective Time (h) / OEE) / 24
```

其中：
- Setup Time (h)：如果Setup="Yes"，使用"Setup Time (h)"，否则为0
- Effective Time (h)：已从标准时间表计算好的单位时间（小时/件）
- 数量：StepInQuantity（MES）或TrackOutQuantity（SFC）
- OEE：默认值0.77

## 使用流程

### 1. 转换标准时间表
```bash
cd "10-SA指标\13-SA数据清洗"
python convert_standard_time.py
```

这会生成：`publish/标准时间表_合并.parquet`

### 2. 运行ETL处理
```bash
# 运行完整流程（SFC + MES）
run_all_etl.bat

# 或单独运行
python etl_sfc.py
python etl_sa.py
```

## 注意事项

1. **Quantity字段**：如果Routing表中没有Quantity或值为空/0，默认使用1
2. **单位转换**：根据Unit字段判断，通常是"S"（秒），需要转换为小时
3. **OEE默认值**：如果机加工清单表中没有OEE或值为空/0，使用0.77
4. **匹配键**：必须包含CFN、Operation，Group字段可选（如果SFC数据没有Group，则按CFN、Operation匹配）

## 输出字段

合并后的标准时间表包含以下关键字段：
- `CFN`：产品号
- `Operation`：工序号（4位补零）
- `Group`：组别
- `Effective Time (h)`：单位时间（小时/件）
- `OEE`：设备综合效率（默认0.77）
- `Setup Time (h)`：调试时间（小时）
- `备注`：备注信息（如果存在）

这些字段会合并到MES和SFC数据中，用于计算ST(d)、DueTime等指标。

