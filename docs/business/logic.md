# 核心计算逻辑 (Business Logic)

本文档详细解释系统中关键指标的计算公式与判定逻辑。

---

## 1. 计划达成率 (Schedule Adherence - SA)

SA 是衡量生产按计划执行程度的核心指标。

> **公式**:  
> **SA % = (按时完成的工时 / 计划总工时) × 100%**

- **按时完成 (On Time)**: 实际产出时间 <= 计划结束时间 (+ 宽限期)
- **计划工时**: 基于 SAP 标准工时 (ST) 计算。

---

## 2. 标准时间 (Standard Time - ST)

ST 代表了**“在标准效率下，生产这批产品理论上需要多久”**。它是计算 OEE 和 SA 的基准。

### 2.1 计算公式

> **ST (天) = (调试时间 + 加工耗时 + 换批缓冲) / 24**

| 组件 | 说明 | 来源 |
|:-----|:-----|:-----|
| **调试时间 (Setup Time)** | 仅当发生换型时计算。| SAP Routing (Setup) |
| **加工耗时 (Run Time)** | `(合格数 + 报废数) × 单件工时 / OEE` | SAP Routing (Labor/Machine) |
| **换批缓冲 (Batch Buffer)** | 固定给予 0.5 小时用于批次切换。 | 系统常量 |

### 2.2 换型判定 (IsSetup)

系统如何判断当前批次是否需要调试时间？

1. **查找上一笔记录**: 在同一机台 (Resource) 上，按时间排序找到上一笔产出。
2. **比对型号 (CFN)**:
    - 如果 `当前 CFN` != `上笔 CFN` ➜ **Yes (换型)**
    - 如果 `当前 CFN` == `上笔 CFN` ➜ **No (连续生产)**
3. **特殊情况**: 当天/该机台的第一笔记录默认为 **Yes**。

---

## 3. 实际周期 (Lead Time - LT)

LT 代表产品在车间实际流转花费的时间（包含等待、排队、加工）。

> **公式**:  
> **LT (天) = (结束时间 - 开始时间) / 24**

### 3.1 时间锚点

- **结束时间 (TrackOut)**: 取自 MES 产出记录。
- **开始时间 (TrackIn)**: 
    - **首道工序 (0010)**: 优先使用 SFC 系统记录的精确 `CheckIn` 时间。如果缺失，则使用上道工序报出时间。
    - **中间工序**: 通常使用上道工序的 `TrackOutTime` 作为本工序的理论开始时间，以计算全流程周期。

---

## 4. 实际加工时间 (Process Time - PT)

PT 试图衡量“真正干活”的时间，剔除非生产性的等待。

> **公式**:  
> **PT = LT - 异常停机时间 - 待料时间**

*(注: 当前版本 PT 计算逻辑主要基于机台 Log 或打卡记录，具体实现见 [ETL 代码](../developer/etl-process.md))*
